#!/usr/bin/env sh

APP_DIR=`dirname $0`

PRG_ARGS=
CMD_CP=

if [[ -f ./hadoop-cli-full-bin.jar ]]; then
    # Look in Current Directory
    CMD_CP=$APP_DIR/hadoop-cli-full-bin.jar
    #echo "Using bin from same directory"
elif [[ -f $APP_DIR/../target/hadoop-cli-full-bin.jar ]]; then
    # Look in ../target
    CMD_CP=$APP_DIR/../target/hadoop-cli-full-bin.jar
    #echo "Using bin from build directory"
else
    # Look in /usr/local/hadoop-cli/lib
    if [[ -f /usr/local/hadoop-cli/lib/hadoop-cli-full-bin.jar ]]; then
        CMD_CP=/usr/local/hadoop-cli/lib/hadoop-cli-full-bin.jar
        #echo "Using bin from installation directory"
    else
        #echo "Couldn't locate Hadoop Cli Library"
        exit 1
    fi
fi

# Set the default.
export HADOOP_CONF_DIR="/etc/hadoop/conf"

AUX_LIBS_DIR=${HADOOP_CLI_AUX_LIBS:-${HOME}/.hadoopcli/aux_libs}

SHOW_CP=
CMD_DIRECTIVE=
CMD_ARGS=

if [[ ! -d ${AUX_LIBS_DIR} ]]; then
    mkdir -p ${AUX_LIBS_DIR}
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --config)
      shift
      export HADOOP_CONF_DIR=$1
      shift
      ;;
    --aux-libs)
      shift
      export AUX_LIBS_DIR=$1
      shift
      ;;
    --show-cp)
      shift
      SHOW_CP="true"
      ;;
    -s|--silent)
      shift
      PRG_ARGS="${PRG_ARGS} -s"
      ;;
    -e|--execute)
      shift
      PRG_ARGS="${PRG_ARGS} -e \"$1\""
      shift
      ;;
    *)
      PRG_ARGS="${PRG_ARGS} $@"
      break;
  esac
done

if [[ ! -d ${AUX_LIBS_DIR} ]]; then
    mkdir -p ${AUX_LIBS_DIR}
fi

for jarFile in `ls -d ${AUX_LIBS_DIR}/*.jar 2> /dev/null`; do
    CMD_CP=${CMD_CP}:$jarFile
done

CLI_CMD=""

if [[ "${SHOW_CP}x" != "x" ]]; then
    echo "Classpath: ${CMD_CP}"
fi

CLI_CMD="${CLI_CMD}java -cp ${CMD_CP} com.streever.hadoop.HadoopShell ${PRG_ARGS}"

eval "${CLI_CMD}"
